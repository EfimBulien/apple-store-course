@model TechStoreEll.Web.Models.ProductDetailViewModel

<div class="container py-5">
    <!-- хлебные крошки -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Главная</a></li>
            <li class="breadcrumb-item"><a href="/">@Model.CategoryName</a></li>
            <li class="breadcrumb-item active" aria-current="page">@Model.Name</li>
        </ol>
    </nav>

    <div class="row g-5">
        <div class="col-lg-6">
            @if (Model.Images.Any())
            {
                <div id="productCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @for (var i = 0; i < Model.Images.Count; i++)
                        {
                            var img = Model.Images[i];
                            <div class="carousel-item @(i == 0 ? "active" : "")">
                                <img src="@img.ImageUrl"
                                     class="d-block w-100 rounded"
                                     alt="@img.AltText"
                                     style="max-height: 500px; object-fit: contain;">
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button"
                            data-bs-target="#productCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon"></span>
                        <span class="visually-hidden">Предыдущее</span>
                    </button>
                    <button class="carousel-control-next" type="button"
                            data-bs-target="#productCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon"></span>
                        <span class="visually-hidden">Следующее</span>
                    </button>

                    <div class="d-flex justify-content-center mt-3 gap-2">
                        @for (var i = 0; i < Model.Images.Count; i++)
                        {
                            var img = Model.Images[i];
                            <img src="@img.ImageUrl" class="img-thumbnail"
                                 style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                                 data-bs-target="#productCarousel" data-bs-slide-to="@i"
                                 aria-current="@(i == 0 ? "true" : "false")" aria-label="Слайд @(i + 1)"
                                 alt="@img.AltText">
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="bg-light d-flex align-items-center justify-content-center rounded" style="height: 400px;">
                    <span class="text-muted">Нет изображения</span>
                </div>
            }
        </div>

        <div class="col-lg-6">
            <h1 class="h2 mb-3">@Model.Name</h1>
            <p class="text-muted">Артикул: @Model.Sku</p>
            <div class="h3 text-primary mb-4">@Model.Price.ToString("C")</div>

            <ul class="list-unstyled mb-4">
                @if (!string.IsNullOrEmpty(Model.Color))
                {
                    <li><strong>Цвет:</strong> @Model.Color</li>
                }
                @if (Model.StorageGb.HasValue)
                {
                    <li><strong>Память:</strong> @Model.StorageGb GB</li>
                }
                @if (Model.Ram.HasValue)
                {
                    <li><strong>RAM:</strong> @Model.Ram GB</li>
                }
            </ul>

            <div class="mb-4">
                <span class="text-warning">
                    @for (var i = 1; i <= 5; i++)
                    {
                        if (Model.AvgRating.HasValue && Model.AvgRating.Value >= i)
                        {
                            <i class="bi bi-star-fill"></i>
                        }
                        else if (Model.AvgRating.HasValue && Model.AvgRating.Value >= i - 0.5m)
                        {
                            <i class="bi bi-star-half"></i>
                        }
                        else
                        {
                            <i class="bi bi-star"></i>
                        }
                    }
                </span>
                <span class="ms-2">@Model.AvgRating?.ToString("F1") / 5</span>
                <span class="text-muted ms-2">(@Model.ReviewsCount отзывов)</span>
            </div>

            <div class="d-grid mb-4">
                <form asp-controller="Cart" asp-action="Add" method="post">
                    <input type="hidden" name="productId" value="@Model.Id" />
                    <input type="hidden" name="name" value="@Model.Name" />
                    <input type="hidden" name="price" value="@Model.Price" />
                    <input type="hidden" name="imageUrl" value="@(Model.Images.FirstOrDefault()?.ImageUrl ?? "")" />
                    <input type="hidden" name="quantity" value="1" />

                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-cart-plus me-2"></i> Добавить в корзину
                    </button>
                </form>
            </div>

            <div>
                <h4 class="mb-3">Описание</h4>
                <p class="text-body">@Model.Description</p>
            </div>
        </div>
    </div>

    <div class="row mt-5">
        <div class="col-12">
            <h3>Отзывы (@Model.ReviewsCount)</h3>

            @if (Model.Reviews.Any())
            {
                <div class="list-group">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between">
                                <strong>@review.AuthorName</strong>
                                <small class="text-muted">@review.CreatedAt.ToString("dd.MM.yyyy")</small>
                            </div>
                            <div class="mt-2">
                                <span class="text-warning">
                                    @for (var i = 1; i <= 5; i++)
                                    {
                                        if (review.Rating >= i)
                                        {
                                            <i class="bi bi-star-fill"></i>
                                        }
                                        else
                                        {
                                            <i class="bi bi-star"></i>
                                        }
                                    }
                                </span>
                            </div>
                            @if (!string.IsNullOrEmpty(review.Comment))
                            {
                                <p class="mt-2 mb-0">@review.Comment</p>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">Пока нет отзывов.</p>
            }
            
            @if (TempData["SuccessMessage"] != null)
            {
                <div class="alert alert-success mt-4" role="alert">
                    @TempData["SuccessMessage"]
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div class="alert alert-danger mt-4" role="alert">
                    @TempData["ErrorMessage"]
                </div>
            }

            @if (User.Identity is { IsAuthenticated: true })
            {
                <h3 class="mt-5">Оставить отзыв</h3>
                <form asp-controller="Home" asp-action="SubmitReview" method="post" class="mt-3">
                    <input type="hidden" name="ProductVariantId" value="@Model.Id" />
                    <div class="mb-3">
                        <label for="rating" class="form-label">Оценка (1-5):</label>
                        <select id="rating" name="Rating" class="form-select" required>
                            <option value="">Выберите оценку</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                            <option value="4">4</option>
                            <option value="5">5</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="comment" class="form-label">Комментарий:</label>
                        <textarea id="comment" name="Comment" class="form-control" rows="4" placeholder="Ваш отзыв о товаре"></textarea>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary">Отправить отзыв</button>
                    </div>
                </form>
            }
            else
            {
                <p class="text-muted mt-3">Войдите в систему, чтобы оставить отзыв.</p>
            }
        </div>
    </div>
</div>
